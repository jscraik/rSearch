name: Auto Release

on:
    push:
        branches: [main]
        paths:
            - "src/**"
            - "package.json"
            - "package-lock.json"

concurrency:
    group: auto-release-${{ github.ref }}
    cancel-in-progress: true

jobs:
    check-changes:
        runs-on: ubuntu-latest
        outputs:
            should_release: ${{ steps.check.outputs.should_release }}
            release_type: ${{ steps.check.outputs.release_type }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Ensure GitHub CLI is installed
              run: bash scripts/ensure-gh-cli.sh
            - name: Check for release-worthy changes
              id: check
              run: |
                  # Check if this is a version bump commit (skip auto-release)
                  if git log -1 --pretty=format:"%s" | grep -q "chore: release v"; then
                    echo "should_release=false" >> $GITHUB_OUTPUT
                    echo "Skipping auto-release for version bump commit"
                    exit 0
                  fi

                  # Check commit messages since last tag for conventional commit patterns
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  if [ -z "$LAST_TAG" ]; then
                    COMMITS=$(git log --pretty=format:"%s" --since="1 week ago")
                  else
                    COMMITS=$(git log --pretty=format:"%s" ${LAST_TAG}..HEAD)
                  fi

                  echo "Checking commits:"
                  echo "$COMMITS"

                  # Determine release type based on conventional commits
                  if echo "$COMMITS" | grep -q "^feat!:\|^fix!:\|BREAKING CHANGE"; then
                    echo "should_release=true" >> $GITHUB_OUTPUT
                    echo "release_type=major" >> $GITHUB_OUTPUT
                    echo "Major release needed (breaking changes detected)"
                  elif echo "$COMMITS" | grep -q "^feat:"; then
                    echo "should_release=true" >> $GITHUB_OUTPUT
                    echo "release_type=minor" >> $GITHUB_OUTPUT
                    echo "Minor release needed (new features detected)"
                  elif echo "$COMMITS" | grep -q "^fix:\|^perf:"; then
                    echo "should_release=true" >> $GITHUB_OUTPUT
                    echo "release_type=patch" >> $GITHUB_OUTPUT
                    echo "Patch release needed (fixes detected)"
                  else
                    echo "should_release=false" >> $GITHUB_OUTPUT
                    echo "No release-worthy changes detected"
                  fi

    auto-release:
        needs: check-changes
        if: needs.check-changes.outputs.should_release == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write
        steps:
            - name: Trigger release workflow
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.actions.createWorkflowDispatch({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        workflow_id: 'release.yml',
                        ref: 'main',
                        inputs: {
                          version_type: '${{ needs.check-changes.outputs.release_type }}',
                          dry_run: 'false'
                        }
                      });

                      console.log(`Triggered ${context.payload.inputs?.release_type || 'patch'} release`);
